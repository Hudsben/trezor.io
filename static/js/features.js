$(document).ready(function () {

  var can = document.getElementById('featureCanvas'),
    ctx = can.getContext('2d'),
    featuresList = document.getElementById("features-list"),
    features = featuresList.getElementsByClassName("entry"),
    width, height, center, feature = 0,
    img = new Image();

  function recalculate () {
    width = can.width = can.scrollWidth;
    height = can.height = can.scrollHeight;
    center = {
      x: width / 2,
      y: height / 2
    };
    feature = {
      'display': {
        'headline': featuresList.getElementsByTagName('h2')[ 0 ],
        'coor_text': {
          x: 20,
          y: 80
        },
        'coor_target': {
          x: center.x + 5,
          y: center.y - 43
        }
      },
      'case': {
        'coor_text': {
          x: width - 20,
          y: 80
        },
        'coor_target': {
          x: center.x + 5,
          y: center.y - 125
        }
      },
      'buttons': {
        'coor_text': {
          x: 20,
          y: center.y - 20
        },
        'coor_target': {
          x: center.x - 20,
          y: center.y + 23
        }
      },
      'inside': {
        'coor_text': {
          x: width - 20,
          y: center.y + 20
        },
        'coor_target': {
          x: center.x + 25,
          y: center.y + 95
        }
      },
      'usb': {
        'coor_text': {
          x: 20,
          y: height - 120
        },
        'coor_target': {
          x: center.x + 10,
          y: center.y + 185
        }
      }
    };
  }

  function wrapText (text, x, y, maxWidth, lineHeight) {
    var cars = text.split("\n");

    for (var ii = 0; ii < cars.length; ii++) {

      var line = "";
      var words = cars[ ii ].split(" ");

      for (var n = 0; n < words.length; n++) {
        var testLine = line + words[ n ] + " ";
        var metrics = ctx.measureText(testLine);
        var testWidth = metrics.width;

        if (testWidth > maxWidth) {
          ctx.fillText(line, x, y);
          line = words[ n ] + " ";
          y += lineHeight;
        }
        else {
          line = testLine;
        }
      }

      ctx.fillText(line, x, y);
      y += lineHeight;
    }
  }

  function paintEntry (key, renderLine) {
    ctx.beginPath();
    ctx.lineWidth = 1;
    ctx.strokeStyle = '#ddd';

    // obtain source target coordinates
    var trgtX = feature[ key ].coor_target.x;
    var trgtY = feature[ key ].coor_target.y;

    // obtain text block coordinates
    var txtX = feature[ key ].coor_text.x;
    var txtY = feature[ key ].coor_text.y;

    // draw text - headline
    var entryBlock = document.getElementById(key);
    var title = entryBlock.getElementsByTagName('h3')[ 0 ].innerHTML;

    drawLinesNCircle(trgtX, trgtY, txtX, txtY, 250);

    ctx.fillStyle = '#ddd';
    ctx.font = "23px 'Open Sans', sans-serif";
    var titleWidth = 250; //ctx.measureText(title).width;
    ctx.fillText(title, txtX < trgtX ? txtX : txtX - titleWidth, txtY - 12);

    // draw text block
    ctx.fillStyle = '#99979c';
    ctx.font = "400 15px/1.75 'Helvetica Neue',Helvetica,Arial,sans-serif";
    var text = entryBlock.getElementsByTagName('p')[ 0 ].innerHTML.trim();
    ctx.textAlign = "left";
    if (txtX < trgtX) {
      wrapText(text, txtX, txtY + 10, titleWidth, 17);
    } else {
      wrapText(text, txtX - titleWidth, txtY + 10, titleWidth, 17);
    }

    // console.log(title, text);
  }

  function drawLinesNCircle (trgtX, trgtY, txtX, txtY, titleWidth) {
    // paint source target circle
    ctx.beginPath();
    ctx.arc(txtX < trgtX ? trgtX + 6 : trgtX - 6, trgtY, 6, 0, 2 * Math.PI);

    // calculate difference step
    var temp = trgtY - txtY;
    ctx.moveTo(trgtX, trgtY);
    if (txtX < trgtX) {
      // text on left
      var newX = trgtX - 120;
      ctx.lineTo(newX, trgtY);
      ctx.lineTo(newX - temp, txtY);

    } else {
      // text on right
      newX = trgtX + 120;
      ctx.lineTo(newX, trgtY);
      ctx.lineTo(newX + temp, txtY);
    }

    // finishing line to text
    ctx.lineTo(txtX, txtY);
    ctx.stroke();

    // hide underline effect
    ctx.fillStyle = '#111111';
    if (txtX < trgtX) {
      ctx.fillRect(txtX, txtY - 1, titleWidth + 15, 4);
    } else {
      ctx.fillRect(txtX - titleWidth - 15, txtY - 1, titleWidth + 15, 4);
    }
  }

  function draw (tempKey) {
    recalculate();
    // TREZOR IMAGE
    ctx.beginPath();
    ctx.drawImage(img, center.x - 82, (height - 380) / 2, 164, 380);
    Object.keys(feature).map(function (key) {
      paintEntry(key, tempKey == key);
    });
  }

  img.onload = function () {
    draw(null);
  };
  img.src = "./static/images/trezor.png";
  $(window).resize(function () {
    draw(null);
  });

  can.addEventListener('mousemove', function (e) {
    var mouseX = e.offsetX;
    var mouseY = e.offsetY;
    var tempKey = null;

    Object.keys(feature).map(function (key) {
      // obtain source target coordinates

      var trgtX = feature[ key ].coor_target.x;
      var trgtY = feature[ key ].coor_target.y;

      // obtain text block coordinates
      var txtX = feature[ key ].coor_text.x;
      var txtY = feature[ key ].coor_text.y;

      if (txtX < trgtX) {
        // text on left
        if (txtX < mouseX && mouseX < txtX + 250) {
          if (txtY - 20 < mouseY && mouseY < txtY + 70) {
            tempKey = key;
          }
        }
      } else {
        // text on right
        if (txtX - 250 < mouseX && mouseX < txtX) {
          if (txtY - 20 < mouseY && mouseY < txtY + 70) {
            tempKey = key;
          }
        }
      }
    });
    draw(tempKey);
    tempKey = null;
  }, true);

});
